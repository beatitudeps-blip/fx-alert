# 3設定比較: 現行 vs 改善版(ATR+Risk) vs 改善版(ATRのみ)

**分析日**: 2026-02-15
**期間**: 2024-01-01 ~ 2026-02-14 (2.1年間)
**対象**: EUR/JPY + USD/JPY（GBP/JPY除外）

---

## 📊 パラメータ設定

| パラメータ | 現行設定 | 改善版(ATR+Risk) | 改善版(ATRのみ) |
|-----------|---------|-----------------|----------------|
| ATR倍率 | 1.2 | **1.0** | **1.0** |
| リスク率 | 0.5% | **0.6%** | 0.5% |
| TP1-R | 1.2 | 1.5 | 1.5 |
| TP2-R | 2.4 | 3.0 | 3.0 |

---

## 📈 EUR/JPY 比較

| 指標 | 現行設定 | 改善版(ATR+Risk) | 改善版(ATRのみ) | 最良 |
|------|---------|-----------------|----------------|------|
| トレード数 | 38 | **85** 🥇 | 67 🥈 | ATR+Risk |
| PF | 1.43 | **1.79** 🥇 | 1.73 🥈 | ATR+Risk |
| 勝率 | **52.6%** 🥇 | 51.8% | 50.7% | 現行 |
| 損益 | +3,609円 | **+15,171円** 🥇 | +10,709円 🥈 | ATR+Risk |
| 年率 | +1.7% | **+7.2%** 🥇 | +5.1% 🥈 | ATR+Risk |
| 最大DD | **1.49%** 🥇 | 2.09% | 1.86% 🥈 | 現行 |
| サイズスキップ | 95件 | **31件** 🥇 | 55件 🥈 | ATR+Risk |
| violations | **0件** 🥇 | 24件 ❌ | 4件 ⚠️ | 現行 |

---

## 📈 USD/JPY 比較

| 指標 | 現行設定 | 改善版(ATR+Risk) | 改善版(ATRのみ) | 最良 |
|------|---------|-----------------|----------------|------|
| トレード数 | 40 | **88** 🥇 | 63 🥈 | ATR+Risk |
| PF | **1.81** 🥇 | 1.41 | 1.49 🥈 | 現行 |
| 勝率 | **60.0%** 🥇 | 48.9% | 49.2% | 現行 |
| 損益 | +5,728円 | **+9,320円** 🥇 | +6,705円 🥈 | ATR+Risk |
| 年率 | +2.7% | **+4.4%** 🥇 | +3.2% 🥈 | ATR+Risk |
| 最大DD | **2.36%** 🥇 | 4.38% | 2.03% 🥈 | 現行 |
| サイズスキップ | 98件 | **29件** 🥇 | 62件 🥈 | ATR+Risk |
| violations | 2件 | 39件 ❌ | **3件** 🥇 | ATRのみ |

---

## 📊 ポートフォリオ合計（EUR/JPY + USD/JPY）

| 指標 | 現行設定 | 改善版(ATR+Risk) | 改善版(ATRのみ) | 最良 |
|------|---------|-----------------|----------------|------|
| **合計トレード** | 78 | **173** 🥇 | 130 🥈 | ATR+Risk |
| **合計損益** | +9,337円 | **+24,491円** 🥇 | +17,414円 🥈 | ATR+Risk |
| **年率リターン** | +4.4% | **+11.6%** 🥇 | +8.3% 🥈 | ATR+Risk |
| **最大DD** | **2.36%** 🥇 | 4.38% | 2.03% 🥈 | 現行 |
| **平均PF** | **1.62** 🥇 | 1.60 🥈 | 1.61 | 現行 |
| **平均勝率** | **56.3%** 🥇 | 50.4% | 50.0% | 現行 |
| **サイズスキップ** | 193件 (71.2%) | **60件** 🥇 (25.8%) | 117件 🥈 (47.4%) | ATR+Risk |
| **violations** | 2件 | 63件 ❌ | **7件** 🥈 | 現行 |

---

## 🎯 各設定の評価

### 現行設定（ATR 1.2, リスク 0.5%）

#### ✅ 強み
- **violations わずか2件**（ほぼゼロ）
- 最大DD 2.36%と低リスク
- 高勝率（EUR 52.6%, USD 60%）
- PF 1.62と高収益性

#### ❌ 弱み
- サイズスキップ 71.2%で実行率低い
- トレード数が少ない（78件）
- 年率4.4%と控えめ

#### 📊 総合評価: ⭐⭐⭐☆☆
**安定性重視、保守的な設定。実運用可能だが機会損失が多い。**

---

### 改善版(ATR+Risk)（ATR 1.0, リスク 0.6%）

#### ✅ 強み
- **年率11.6%**と目標達成 🎯
- トレード数173件で実行率大幅改善
- サイズスキップ 25.8%に激減
- 損益+24,491円と最高

#### ❌ 弱み
- **violations 63件で実運用不可** ❌
- 最大DD 4.38%と高リスク
- 勝率50.4%、PF 1.60と低下

#### 📊 総合評価: ⭐⭐☆☆☆
**パフォーマンスは最高だがリスク管理破綻。実運用不可。**

---

### 改善版(ATRのみ)（ATR 1.0, リスク 0.5%）

#### ✅ 強み
- 年率8.3%と優秀（目標範囲内）
- トレード数130件で実行率改善
- サイズスキップ 47.4%（現行の2/3）
- 損益+17,414円と大幅改善
- 最大DD 2.03%と低リスク維持

#### ❌ 弱み
- **violations 7件**（要改善）
- サイズスキップは依然47%残る
- 勝率50%とやや低下

#### 📊 総合評価: ⭐⭐⭐⭐☆
**バランス良好。violations修正後は実運用推奨。**

---

## 💡 最終推奨

### 🏆 推奨設定: **改善版(ATRのみ)**

| パラメータ | 値 |
|-----------|-----|
| symbols | EUR/JPY, USD/JPY |
| atr_multiplier | **1.0** |
| risk_pct | **0.005** (0.5%) |
| tp1_r | **1.5** |
| tp2_r | **3.0** |

### 理由

1. **年率8.3%** → 目標範囲（8-12%）の下限を達成
2. **トレード数130件** → 現行の1.7倍で機会損失削減
3. **サイズスキップ47%** → 現行の2/3に改善
4. **最大DD 2.03%** → 低リスク維持
5. **violations 7件** → position_sizing修正で0件達成可能

### 期待パフォーマンス（violations修正後）

| 指標 | 期待値 |
|------|--------|
| 年率リターン | **+8-9%** |
| トレード数/年 | **~60件** |
| 最大DD | **~2%** |
| violations | **0件** ✅ |
| 実行率 | **~53%** |

---

## 🚨 violations 問題の対処

### 現状

| 設定 | violations数 | リスク率 |
|------|-------------|---------|
| 現行 | 2件 | 0.5% |
| 改善版(ATRのみ) | **7件** | 0.5% |
| 改善版(ATR+Risk) | 63件 | 0.6% |

### 原因仮説

1. **TP1/TP2のR倍数変更の影響**
   - TP1 1.2R→1.5R、TP2 2.4R→3.0R
   - エグジットロジックの変更がリスク計算に影響？

2. **ATR 1.0でボラティリティ変動の影響拡大**
   - SL距離が短くなることで、ボラ急変時の計算誤差が拡大？

3. **position_sizing.pyのバグ**
   - 丸め後の再チェックロジックに不具合
   - 複利効果での資産増加を考慮していない？

### 対策

1. ✅ **violations.csvを確認**
   ```bash
   cat data/results_v4/improved_atr_only_20240101_20260214/EUR_JPY/trades.csv | \
     awk -F',' '$NF > 500 {print}'
   ```

2. ✅ **position_sizing.pyにデバッグログ追加**
   - 計算過程を詳細記録
   - 丸め前後の値を比較

3. ✅ **単体テスト強化**
   - エッジケースのテスト追加
   - ATR 1.0でのテスト

---

## 📋 次のアクション

### 優先度：高（必須）

1. ✅ **violations の根本原因特定**
   - trades.csvから違反トレードを抽出
   - initial_risk_jpy vs 500円を比較

2. ✅ **position_sizing.py 修正**
   - バグ修正
   - テスト追加

3. ✅ **修正後に再バックテスト**
   - ATR 1.0 + リスク 0.5%
   - violations=0を確認

### 優先度：中（推奨）

4. ✅ **LINE通知の見送り内容最適化**
   - 1行/通貨で簡潔に
   - 次のチェック時刻表示

5. ✅ **README更新**
   - 手順ドキュメント整備
   - crontab例の追加

---

## 🎯 結論

**推奨設定**: ATR 1.0 + リスク 0.5% + TP1 1.5R + TP2 3.0R

**期待効果**:
- 年率 **+8-9%**（現行+4.4%から2倍）
- トレード数 **130件**（現行78件から1.7倍）
- サイズスキップ **47%**（現行71%から改善）
- 最大DD **2.03%**（低リスク維持）

**必須対応**: violations 7件の修正 → 修正後は実運用可能

---

**最終更新**: 2026-02-15
