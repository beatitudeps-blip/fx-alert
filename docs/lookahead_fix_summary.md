# ルックアヘッドバイアス修正完了レポート

## 修正日時
2026-02-16

## 問題の概要

### 発見された重大なバグ
**signal_detector.py** で未確定の4H足を使ってシグナル判定していた（ルックアヘッドバイアス）

#### 具体例（16:56実行時）
- **バグあり（修正前）**:
  - コード: `h4[h4["datetime"] < now]`
  - 16:00ラベルの足（16:00-20:00範囲）を「確定」と判定
  - しかしこの足は20:00までクローズしない → **未確定データを使用**

- **修正後**:
  - コード: `h4[h4_end_time <= now]` where `h4_end_time = datetime + 4h`
  - 16:00足（16:00-20:00）は20:00 > 16:56なので **正しく除外**
  - 12:00足（12:00-16:00）は16:00 <= 16:56なので **確定として使用**

---

## 実装した修正

### 1. 確定判定ロジックの修正

#### [src/signal_detector.py](../src/signal_detector.py) (Line 127-132)

**修正前（ルックアヘッドバイアスあり）:**
```python
# 現在時刻よりも古いデータのみ使用（確定した足のみ）
now = datetime.now(tz)
h4_past = h4[h4["datetime"] < now].copy()  # ❌ バグ: ラベル時刻で判定
```

**修正後（正しい確定判定）:**
```python
# 確定した足のみ使用（足の終了時刻で判定）
# TwelveData APIは開始時刻をラベルにするため、bar_end_time <= now で確定判定
now = datetime.now(tz)
h4_end_time = h4["datetime"] + pd.Timedelta(hours=4)
h4_past = h4[h4_end_time <= now].copy()  # ✅ 足の終了時刻で判定
```

---

### 2. 「1本待ち」戦略の実装

#### [src/signal_detector.py](../src/signal_detector.py) (Line 224-228)

**修正前:**
```python
# エントリー予定時刻 = 次の4H足の始値時刻
entry_dt = bar_dt + timedelta(hours=4)  # ❌ 確定直後にエントリー
```

**修正後:**
```python
# エントリー予定時刻 = 1本待ち戦略（次の次の4H足の始値時刻）
# 例: 確定足12:00-16:00 → 次足16:00-20:00をスキップ → 20:00エントリー
entry_dt = bar_dt + timedelta(hours=8)  # ✅ 1本待ち
```

#### ロジック図解
```
確定足    : 12:00-16:00 (16:00に確定)
スキップ  : 16:00-20:00 (この足を見送り)
エントリー: 20:00 (次の次の足の始値)
```

---

### 3. 通知メッセージの明確化

#### [src/notify_line.py](../src/notify_line.py) (Line 165-176)

**修正前（曖昧）:**
```python
msg = f"""🚨 {symbol} {emoji} {direction_jp}シグナル

【シグナル情報】
パターン: {pattern}
シグナル足: {signal_dt.strftime('%Y-%m-%d %H:%M JST')}  # ❌ 曖昧
次足始値: {next_dt.strftime('%Y-%m-%d %H:%M JST')}      # ❌ 誤解を招く
```

**修正後（明確）:**
```python
# 確定足の範囲を計算
bar_start = signal_dt
bar_end = signal_dt + timedelta(hours=4)

msg = f"""🚨 {symbol} {emoji} {direction_jp}シグナル

【シグナル情報】
パターン: {pattern}
確定足ラベル: {signal_dt.strftime('%Y-%m-%d %H:%M JST')}     # ✅ 明確
確定足範囲: {bar_start.strftime('%H:%M')}〜{bar_end.strftime('%H:%M')}  # ✅ 範囲表示
エントリー時刻: {next_dt.strftime('%Y-%m-%d %H:%M JST')}     # ✅ 正確
```

#### バッチ通知（[src/notify_line.py](../src/notify_line.py) Line 284-294）

**修正前:**
```python
next_dt = bar_dt + timedelta(hours=4)  # ❌ +4h
msg = f"""📊 4H足確定通知（{len(results)}通貨）

【確定足】{bar_dt.strftime('%Y-%m-%d %H:%M JST')}
【次足始値】{next_dt.strftime('%Y-%m-%d %H:%M JST')}  # ❌ 曖昧
```

**修正後:**
```python
# 1本待ち戦略: 確定足の2本後（+8h）でエントリー
entry_dt = bar_dt + timedelta(hours=8)  # ✅ +8h
bar_end = bar_dt + timedelta(hours=4)

msg = f"""📊 4H足確定通知（{len(results)}通貨）

【確定足ラベル】{bar_dt.strftime('%Y-%m-%d %H:%M JST')}
【確定足範囲】{bar_dt.strftime('%H:%M')}〜{bar_end.strftime('%H:%M')}
【エントリー時刻】{entry_dt.strftime('%Y-%m-%d %H:%M JST')}  # ✅ 明確
```

---

### 4. バックテストの整合性修正

#### [src/backtest_v4_integrated.py](../src/backtest_v4_integrated.py) (Line 360-375)

**修正前:**
```python
if active_trade is None and i < len(h4) - 1:  # ❌ 次の1本だけチェック
    ...
    if signal["signal"]:
        # 次のバーでエントリー（NEXT_OPEN_MARKET）
        next_bar = h4.iloc[i + 1]  # ❌ i+1（確定直後）
```

**修正後:**
```python
if active_trade is None and i < len(h4) - 2:  # ✅ 次の2本分チェック
    ...
    if signal["signal"]:
        # 1本待ち戦略: 次の次のバーでエントリー（NEXT_OPEN_MARKET）
        # 例: i=確定足 → i+1=スキップ → i+2=エントリー
        next_bar = h4.iloc[i + 2]  # ✅ i+2（1本待ち）
```

---

## 検証結果

### Debug Script実行結果（2026-02-16 19:44 JST）

```
================================================================================
4H足の時刻定義とエントリータイミング検証
================================================================================

現在時刻: 2026-02-16 19:44:26 JST

最新5本の4H足（新しい順）:
--------------------------------------------------------------------------------
❌未確定 | ラベル: 2026-02-16 20:00 JST
         推定範囲: 20:00〜00:00
         確定時刻: 2026-02-17 00:00 JST  ← まだ確定していない

❌未確定 | ラベル: 2026-02-16 16:00 JST
         推定範囲: 16:00〜20:00
         確定時刻: 2026-02-16 20:00 JST  ← まだ確定していない

✅確定 | ラベル: 2026-02-16 12:00 JST
         推定範囲: 12:00〜16:00
         確定時刻: 2026-02-16 16:00 JST  ← 16:00に確定済み

================================================================================
シグナル判定に使う足（最新確定足）
================================================================================
時刻ラベル: 2026-02-16 12:00 JST  ← ✅ 正しく12:00足を使用
OHLC: O=181.261 H=181.458 L=181.049 C=181.270

================================================================================
エントリー時刻の計算（1本待ち戦略）
================================================================================
計算式: entry_dt = bar_dt + timedelta(hours=8)
bar_dt (確定足ラベル): 2026-02-16 12:00 JST
確定足範囲: 12:00〜16:00
スキップする足: 16:00〜20:00  ← 次の足をスキップ
entry_dt (エントリー時刻): 2026-02-16 20:00 JST  ← ✅ 20:00エントリー
```

### 検証結果の解釈

#### ✅ 確定判定が正しく動作
- 現在時刻 19:44 JST
- 16:00足（16:00-20:00）は **❌未確定** として正しく除外
- 12:00足（12:00-16:00）は **✅確定** として正しく使用

#### ✅ 1本待ち戦略が正しく動作
- 確定足: 12:00-16:00
- スキップ: 16:00-20:00
- エントリー: 20:00 ← 確定の2本後

#### ✅ ルックアヘッドバイアス完全除去
- 未確定の16:00足を使わない
- 確定済みの12:00足のみでシグナル判定
- エントリーは20:00（確定から4時間後）

---

## バックテストとの整合性

### ✅ 完全に整合

| 項目 | バックテスト | 実運用（signal_detector） | 整合性 |
|------|-------------|--------------------------|--------|
| 確定判定 | `i` (確定済み足のみループ) | `bar_end_time <= now` | ✅ 同じ |
| エントリータイミング | `h4.iloc[i + 2]` | `bar_dt + timedelta(hours=8)` | ✅ 同じ |
| 戦略 | 1本待ち | 1本待ち | ✅ 同じ |

### 例: 12:00足でシグナル発生時

**バックテスト:**
1. `i` = 12:00足のインデックス（確定済み）
2. `i+1` = 16:00足（スキップ）
3. `i+2` = 20:00足の始値でエントリー

**実運用（16:56実行時）:**
1. `bar_dt` = 12:00（確定足ラベル、16:00に確定）
2. スキップ: 16:00-20:00
3. `entry_dt` = 20:00でエントリー

→ **✅ 完全一致（ルックアヘッドなし）**

---

## 新しい通知メッセージ例

### シグナル通知
```
🚨 EUR/JPY 🔼 買いシグナル

【シグナル情報】
パターン: Bullish Engulfing
確定足ラベル: 2026-02-16 12:00 JST
確定足範囲: 12:00〜16:00
エントリー時刻: 2026-02-16 20:00 JST

【エントリー】
注文種別: 成行
推奨価格: 181.333円
...
```

### バッチ通知ヘッダー
```
📊 4H足確定通知（2通貨）

【確定足ラベル】2026-02-16 12:00 JST
【確定足範囲】12:00〜16:00
【エントリー時刻】2026-02-16 20:00 JST
【実行時刻】2026-02-16 16:56:11 JST
```

---

## 影響範囲

### 修正したファイル
1. **src/signal_detector.py** - 確定判定ロジック修正、1本待ち実装
2. **src/notify_line.py** - 通知メッセージ明確化
3. **src/backtest_v4_integrated.py** - バックテストの整合性修正
4. **scripts/debug_bar_timing.py** - 検証スクリプト更新

### テスト結果
- ✅ Debug script実行成功（確定判定が正しく動作）
- ✅ バックテストロジック整合確認
- ✅ 通知メッセージ明確化完了

---

## 今後の運用

### GitHub Actionsでの動作
例: 16:05にスケジュール実行（実際には16:55に実行される場合）

**修正前（バグあり）:**
- 16:00足（16:00-20:00）を「確定」と誤判定
- → **ルックアヘッドバイアス発生**

**修正後（正しい）:**
- 16:00足（16:00-20:00）は20:00まで未確定として除外
- 12:00足（12:00-16:00）でシグナル判定
- エントリー時刻: 20:00
- → **✅ ルックアヘッドなし**

---

## まとめ

### 修正内容
1. ✅ **確定判定**: `datetime < now` → `bar_end_time <= now`
2. ✅ **1本待ち戦略**: `+4h` → `+8h` エントリー
3. ✅ **通知明確化**: ラベル、範囲、エントリー時刻を明示
4. ✅ **バックテスト整合**: `i+1` → `i+2` エントリー

### 効果
- ✅ **ルックアヘッドバイアス完全除去**
- ✅ **バックテストと実運用の完全一致**
- ✅ **通知メッセージの誤解防止**

### 検証結果
- ✅ Debug script: 確定判定が正しく動作
- ✅ 19:44時点で16:00足を未確定として正しく除外
- ✅ 12:00足でシグナル判定、20:00エントリー計算

---

## 参考資料
- [scripts/debug_bar_timing.py](../scripts/debug_bar_timing.py) - 検証スクリプト
- [src/signal_detector.py](../src/signal_detector.py) - 修正済みコード
- [src/backtest_v4_integrated.py](../src/backtest_v4_integrated.py) - 修正済みバックテスト
